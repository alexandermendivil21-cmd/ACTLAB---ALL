<section class="pago-cita">
  <div class="section-header">
    <button class="btn-back" id="btnVolverPago" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
      <i class="fa-solid fa-arrow-left"></i> Volver
    </button>
    <h1>Realizar Pago</h1>
    <p class="muted">Complete el pago para confirmar su cita m√©dica.</p>
  </div>

  <div class="pago-container">
    <!-- Informaci√≥n del Paciente -->
    <div class="card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid #3b82f6;">
      <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem;">
        <i class="fa-solid fa-user" style="color: #3b82f6;"></i>
        Informaci√≥n del Paciente
      </h3>
      <div class="cita-info" id="infoPaciente">
        <div class="info-item">
          <span class="info-label">
            <i class="fa-solid fa-user" style="margin-right: 0.5rem;"></i>Nombre:
          </span>
          <span class="info-value" id="nombrePaciente">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">
            <i class="fa-solid fa-envelope" style="margin-right: 0.5rem;"></i>Correo:
          </span>
          <span class="info-value" id="correoPaciente">-</span>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n de la cita -->
    <div class="card">
      <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem;">
        <i class="fa-solid fa-calendar-check" style="color: #3b82f6;"></i>
        Informaci√≥n de la Cita
      </h3>
      <div class="cita-info" id="citaInfo">
        <div class="info-item">
          <span class="info-label">
            <i class="fa-solid fa-stethoscope" style="margin-right: 0.5rem;"></i>Especialidad:
          </span>
          <span class="info-value" id="especialidadCita">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">
            <i class="fa-solid fa-calendar" style="margin-right: 0.5rem;"></i>Fecha:
          </span>
          <span class="info-value" id="fechaCita">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">
            <i class="fa-solid fa-clock" style="margin-right: 0.5rem;"></i>Horario:
          </span>
          <span class="info-value" id="horarioCita">-</span>
        </div>
        <div class="info-item" style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
          <span class="info-label" style="font-size: 1.125rem;">
            <i class="fa-solid fa-dollar-sign" style="margin-right: 0.5rem;"></i>Monto a pagar:
          </span>
          <span class="info-value monto-destacado" id="montoCita">S/ 50.00</span>
        </div>
      </div>
    </div>

    <!-- Formulario de pago -->
    <div class="card">
      <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem;">
        <i class="fa-solid fa-credit-card" style="color: #3b82f6;"></i>
        M√©todo de Pago
      </h3>
      <form id="formPago" class="pago-form">
        <input type="hidden" id="citaId" />
        <input type="hidden" id="emailPaciente" />
        
        <div class="form-group">
          <label style="font-weight: 600; color: #374151; margin-bottom: 1rem; display: block;">
            Seleccione el m√©todo de pago:
          </label>
          <div class="metodos-pago">
            <label class="metodo-pago-option selected" id="option-tarjeta">
              <input type="radio" name="metodo" value="tarjeta" checked />
              <div class="metodo-content">
                <i class="fa-solid fa-credit-card" style="color: #2563eb;"></i>
                <span>Tarjeta de Cr√©dito/D√©bito</span>
                <small style="font-size: 0.75rem; opacity: 0.7;">Visa, Mastercard</small>
              </div>
              <div class="check-indicator">
                <i class="fa-solid fa-check"></i>
              </div>
            </label>
            <label class="metodo-pago-option" id="option-yape">
              <input type="radio" name="metodo" value="yape" />
              <div class="metodo-content">
                <i class="fa-solid fa-mobile-screen-button" style="color: #25d366;"></i>
                <span>Yape</span>
                <small style="font-size: 0.75rem; opacity: 0.7;">Transferencia r√°pida</small>
              </div>
              <div class="check-indicator">
                <i class="fa-solid fa-check"></i>
              </div>
            </label>
            <label class="metodo-pago-option" id="option-plin">
              <input type="radio" name="metodo" value="plin" />
              <div class="metodo-content">
                <i class="fa-solid fa-mobile-screen-button" style="color: #8b5cf6;"></i>
                <span>Plin</span>
                <small style="font-size: 0.75rem; opacity: 0.7;">Billetera digital</small>
              </div>
              <div class="check-indicator">
                <i class="fa-solid fa-check"></i>
              </div>
            </label>
            <label class="metodo-pago-option" id="option-efectivo">
              <input type="radio" name="metodo" value="efectivo" />
              <div class="metodo-content">
                <i class="fa-solid fa-money-bill-wave" style="color: #059669;"></i>
                <span>Efectivo</span>
                <small style="font-size: 0.75rem; opacity: 0.7;">Pago en persona</small>
              </div>
              <div class="check-indicator">
                <i class="fa-solid fa-check"></i>
              </div>
            </label>
          </div>
        </div>

        <!-- Campos de tarjeta (solo visibles cuando se selecciona tarjeta) -->
        <div id="camposTarjeta" class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb; display: none;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 1rem; display: block;">
            <i class="fa-solid fa-credit-card" style="margin-right: 0.5rem; color: #2563eb;"></i>
            Informaci√≥n de Tarjeta
          </label>
          
          <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
            <!-- N√∫mero de Tarjeta -->
            <div>
              <label for="numeroTarjeta" style="font-weight: 500; color: #6b7280; margin-bottom: 0.5rem; display: block; font-size: 0.875rem;">
                N√∫mero de Tarjeta
              </label>
              <input 
                type="text" 
                id="numeroTarjeta" 
                name="numeroTarjeta"
                placeholder="1234 5678 9012 3456"
                maxlength="19"
                style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s;"
              />
              <small style="color: #9ca3af; font-size: 0.75rem; margin-top: 0.25rem; display: block;">
                Ingrese los 16 d√≠gitos de su tarjeta
              </small>
            </div>
            
            <!-- Fecha de Expiraci√≥n y CVV en una fila -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <!-- Fecha de Expiraci√≥n -->
              <div>
                <label for="fechaExpiracion" style="font-weight: 500; color: #6b7280; margin-bottom: 0.5rem; display: block; font-size: 0.875rem;">
                  Fecha de Expiraci√≥n
                </label>
                <input 
                  type="text" 
                  id="fechaExpiracion" 
                  name="fechaExpiracion"
                  placeholder="MM/AA"
                  maxlength="5"
                  style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s;"
                />
                <small style="color: #9ca3af; font-size: 0.75rem; margin-top: 0.25rem; display: block;">
                  MM/AA
                </small>
              </div>
              
              <!-- CVV -->
              <div>
                <label for="cvv" style="font-weight: 500; color: #6b7280; margin-bottom: 0.5rem; display: block; font-size: 0.875rem;">
                  CVV
                </label>
                <input 
                  type="text" 
                  id="cvv" 
                  name="cvv"
                  placeholder="123"
                  maxlength="4"
                  style="width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s;"
                />
                <small style="color: #9ca3af; font-size: 0.75rem; margin-top: 0.25rem; display: block;">
                  3 o 4 d√≠gitos
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Secci√≥n Yape con QR (solo visible cuando se selecciona Yape) -->
        <div id="seccionYape" class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb; display: none;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 1rem; display: block;">
            <i class="fa-solid fa-mobile-screen-button" style="margin-right: 0.5rem; color: #25d366;"></i>
            Pago con Yape
          </label>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start;" class="yape-grid-responsive">
            <!-- QR Code -->
            <div style="text-align: center;">
              <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 2px solid #e5e7eb; display: inline-block; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                <div id="qrCodeYape" style="width: 220px; height: 220px; background: white; border: 1px solid #d1d5db; border-radius: 8px; margin: 0 auto; position: relative; padding: 10px; box-sizing: border-box; display: flex; align-items: center; justify-content: center;">
                  <!-- El QR se generar√° din√°micamente con JavaScript -->
                  <div style="color: #9ca3af; font-size: 0.875rem;">Cargando QR...</div>
                </div>
                <p style="margin-top: 1rem; color: #25d366; font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                  <i class="fa-solid fa-qrcode"></i>
                  Escanea con la app Yape
                </p>
              </div>
            </div>
            
            <!-- Informaci√≥n del pago -->
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 12px; border: 2px solid #25d366;">
                <h4 style="color: #059669; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fa-solid fa-info-circle"></i>
                  Detalles del Pago
                </h4>
                
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #d1fae5;">
                    <span style="color: #6b7280; font-weight: 500;">Paciente:</span>
                    <span style="color: #111827; font-weight: 600;" id="yapeNombrePaciente">-</span>
                  </div>
                  
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #d1fae5;">
                    <span style="color: #6b7280; font-weight: 500;">Correo:</span>
                    <span style="color: #111827; font-weight: 600; font-size: 0.875rem;" id="yapeCorreoPaciente">-</span>
                  </div>
                  
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #d1fae5;">
                    <span style="color: #6b7280; font-weight: 500;">Fecha de Cita:</span>
                    <span style="color: #111827; font-weight: 600;" id="yapeFechaCita">-</span>
                  </div>
                  
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #d1fae5;">
                    <span style="color: #6b7280; font-weight: 500;">Horario:</span>
                    <span style="color: #111827; font-weight: 600;" id="yapeHorarioCita">-</span>
                  </div>
                  
                  <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; margin-top: 0.5rem; border-top: 2px solid #25d366;">
                    <span style="color: #059669; font-weight: 700; font-size: 1.125rem;">Importe:</span>
                    <span style="color: #059669; font-weight: 700; font-size: 1.5rem;" id="yapeImporte">S/ 0.00</span>
                  </div>
                </div>
              </div>
              
              <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <p style="color: #92400e; font-size: 0.875rem; margin: 0; display: flex; align-items: start; gap: 0.5rem;">
                  <i class="fa-solid fa-circle-info" style="margin-top: 0.125rem;"></i>
                  <span>Despu√©s de realizar el pago con Yape, confirma el pago haciendo clic en "Confirmar Pago".</span>
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
          <label for="montoPago" style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
            <i class="fa-solid fa-dollar-sign" style="margin-right: 0.5rem; color: #059669;"></i>
            Monto a Pagar (S/)
          </label>
          <input 
            type="number" 
            id="montoPago" 
            step="0.01" 
            min="0" 
            value="50.00" 
            required 
            readonly
            style="width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1.25rem; font-weight: 700; color: #059669; background: #f0fdf4; text-align: right;"
          />
          <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; display: block;">
            El monto se calcula autom√°ticamente seg√∫n la especialidad seleccionada.
          </small>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" id="btnCancelarPago">
            <i class="fa-solid fa-times" style="margin-right: 0.5rem;"></i>
            Cancelar
          </button>
          <button type="submit" class="btn-primary" id="btnConfirmarPago">
            <i class="fa-solid fa-check" style="margin-right: 0.5rem;"></i>
            Confirmar Pago
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n -->
  <div id="modalPago" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-icon success">
        <i class="fa-solid fa-check-circle"></i>
      </div>
      <h3 id="modalTitulo">Pago Exitoso</h3>
      <p id="modalMensaje">Su pago ha sido procesado correctamente.</p>
      <button type="button" class="btn-primary" id="btnCerrarModal">Aceptar</button>
    </div>
  </div>
</section>

<style>
.pago-cita {
  padding: 2rem;
  max-width: 900px;
  margin: 0 auto;
}

.pago-container {
  display: grid;
  gap: 2rem;
  margin-top: 2rem;
}

.cita-info {
  display: grid;
  gap: 1rem;
  padding: 1.5rem;
}

.info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid #e5e7eb;
}

.info-item:last-child {
  border-bottom: none;
}

.info-label {
  font-weight: 600;
  color: #6b7280;
}

.info-value {
  font-weight: 500;
  color: #111827;
}

.monto-destacado {
  font-size: 1.5rem;
  color: #059669;
  font-weight: 700;
}

.metodos-pago {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.metodo-pago-option {
  display: block;
  cursor: pointer;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 1.5rem;
  transition: all 0.3s ease;
  background: white;
  position: relative;
}

.metodo-pago-option:hover {
  border-color: #3b82f6;
  background-color: #eff6ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

.metodo-pago-option input[type="radio"] {
  display: none;
}

.metodo-pago-option input[type="radio"]:checked + .metodo-content {
  color: #3b82f6;
  font-weight: 600;
}

.metodo-pago-option input[type="radio"]:checked ~ .metodo-content i {
  transform: scale(1.1);
}

.metodo-pago-option input[type="radio"]:checked ~ .check-indicator {
  display: block;
}

.check-indicator {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  width: 24px;
  height: 24px;
  background: #3b82f6;
  border-radius: 50%;
  display: none;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 0.75rem;
}

.metodo-pago-option input[type="radio"]:checked + .metodo-content + .check-indicator {
  display: flex;
}

/* Estilo cuando est√° seleccionado */
.metodo-pago-option input[type="radio"]:checked + .metodo-content {
  color: #3b82f6;
}

/* El estado seleccionado se maneja con JavaScript */

/* Usar JavaScript para manejar el estado seleccionado */
.metodo-pago-option.selected {
  border-color: #3b82f6;
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.metodo-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.75rem;
  color: #6b7280;
  transition: all 0.3s ease;
  text-align: center;
}

.metodo-content i {
  font-size: 2.5rem;
  transition: all 0.3s ease;
}

.metodo-content span {
  font-size: 1rem;
  font-weight: 500;
}

.pago-form {
  padding: 1.5rem;
}

.form-actions {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
  justify-content: flex-end;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  max-width: 400px;
  text-align: center;
}

.modal-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

.modal-icon.success {
  color: #059669;
}

.btn-primary, .btn-secondary {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-primary {
  background: #3b82f6;
  color: white;
}

.btn-primary:hover {
  background: #2563eb;
}

.btn-secondary {
  background: #e5e7eb;
  color: #374151;
}

.btn-secondary:hover {
  background: #d1d5db;
}

/* Animaci√≥n para campos de tarjeta */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Estilos para campos de tarjeta */
#camposTarjeta input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

#camposTarjeta input:invalid:not(:placeholder-shown) {
  border-color: #ef4444;
}

/* Estilos para secci√≥n Yape */
#seccionYape {
  animation: fadeIn 0.3s ease-in;
}

#seccionYape .form-group {
  animation: fadeIn 0.3s ease-in;
}

/* Responsive para secci√≥n Yape */
@media (max-width: 768px) {
  #seccionYape > div[style*="grid-template-columns"] {
    grid-template-columns: 1fr !important;
  }
  
  #qrCodeYape {
    width: 180px !important;
    height: 180px !important;
  }
}
</style>

<script>
// Este script se ejecuta cuando la p√°gina se carga directamente
// Si se carga din√°micamente, initPagarCitaView() en dashboardPaciente.js manejar√° la inicializaci√≥n
(function() {
  // Solo ejecutar si no estamos en el dashboard din√°mico
  if (typeof loadSection === 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      // Obtener datos de la URL o sessionStorage
      const urlParams = new URLSearchParams(window.location.search);
      const citaId = urlParams.get('citaId') || sessionStorage.getItem('ultimaCitaId');
      const email = sessionStorage.getItem('userEmail');
      
      // Si no hay citaId, redirigir a citas
      if (!citaId) {
        alert('No se encontr√≥ informaci√≥n de la cita. Redirigiendo...');
        window.location.href = '/user/citas';
        return;
      }

  // Funci√≥n para obtener precio por especialidad
  const getPrecioEspecialidad = (especialidad) => {
    const precios = {
      "Cardiolog√≠a": 80.00,
      "Dermatolog√≠a": 60.00,
      "Pediatr√≠a": 50.00,
      "Traumatolog√≠a": 70.00,
      "Neurolog√≠a": 90.00,
      "Hematolog√≠a": 65.00,
      "Inmunolog√≠a": 75.00,
      "Bioqu√≠mica": 55.00,
    };
    return precios[especialidad] || 50.00; // Precio por defecto
  };

  // Cargar informaci√≥n del paciente
  const cargarInfoPaciente = async () => {
    try {
      const res = await fetch(`http://localhost:5000/api/perfil?email=${encodeURIComponent(email)}`);
      if (!res.ok) throw new Error('Error al cargar perfil');
      const perfil = await res.json();
      
      const nombreCompleto = `${perfil.nombres || ''} ${perfil.apellidos || ''}`.trim() || 'Usuario';
      document.getElementById('nombrePaciente').textContent = nombreCompleto;
      document.getElementById('correoPaciente').textContent = email || '-';
      
      // Actualizar datos en la secci√≥n Yape si est√° visible
      setTimeout(() => {
        if (typeof window.actualizarDatosYape === 'function') {
          window.actualizarDatosYape();
        }
      }, 100);
    } catch (error) {
      console.warn('Error al cargar perfil del paciente:', error);
      document.getElementById('nombrePaciente').textContent = 'Usuario';
      document.getElementById('correoPaciente').textContent = email || '-';
      
      // Actualizar datos en la secci√≥n Yape si est√° visible
      setTimeout(() => {
        if (typeof window.actualizarDatosYape === 'function') {
          window.actualizarDatosYape();
        }
      }, 100);
    }
  };

  // Cargar informaci√≥n de la cita
  const cargarInfoCita = async () => {
    try {
      // Intentar obtener la cita directamente por ID si hay un endpoint, o por email
      const res = await fetch(`http://localhost:5000/api/citas?email=${encodeURIComponent(email)}`);
      if (!res.ok) throw new Error('Error al cargar cita');
      const citas = await res.json();
      const cita = Array.isArray(citas) ? citas.find(c => c._id === citaId) : null;
      
      if (cita) {
        document.getElementById('citaId').value = citaId;
        document.getElementById('emailPaciente').value = email;
        document.getElementById('especialidadCita').textContent = cita.especialidad;
        
        const fecha = new Date(cita.fechaCita);
        document.getElementById('fechaCita').textContent = fecha.toLocaleDateString('es-ES', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        document.getElementById('horarioCita').textContent = cita.horario;
        
        // Obtener el precio seg√∫n la especialidad
        const precio = getPrecioEspecialidad(cita.especialidad);
        document.getElementById('montoCita').textContent = `S/ ${precio.toFixed(2)}`;
        document.getElementById('montoPago').value = precio.toFixed(2);
        
        // Actualizar datos en la secci√≥n Yape si est√° visible
        setTimeout(() => {
          if (typeof window.actualizarDatosYape === 'function') {
            window.actualizarDatosYape();
          }
        }, 100);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al cargar informaci√≥n de la cita');
    }
  };

  // Manejar el pago
  const formPago = document.getElementById('formPago');
  const btnConfirmarPago = document.getElementById('btnConfirmarPago');
  
  formPago.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const citaId = document.getElementById('citaId').value;
    const email = document.getElementById('emailPaciente').value;
    const monto = parseFloat(document.getElementById('montoPago').value);
    const metodoSeleccionado = document.querySelector('input[name="metodo"]:checked');
    
    if (!citaId || !email || !monto) {
      alert('Por favor complete todos los campos');
      return;
    }
    
    if (!metodoSeleccionado) {
      alert('Por favor seleccione un m√©todo de pago');
      return;
    }
    
    const metodo = metodoSeleccionado.value;
    
    // Validar que el m√©todo sea v√°lido
    const metodosValidos = ['tarjeta', 'yape', 'plin', 'efectivo'];
    if (!metodosValidos.includes(metodo)) {
      alert('M√©todo de pago inv√°lido');
      return;
    }
    
    // Validar campos de tarjeta si el m√©todo es tarjeta
    if (metodo === 'tarjeta') {
      if (!validarCamposTarjeta()) {
        return; // La validaci√≥n ya mostr√≥ el mensaje de error
      }
    }
    
    // Confirmar antes de procesar
    const confirmar = confirm(`¬øConfirmar el pago de S/ ${monto.toFixed(2)} mediante ${metodo}?`);
    if (!confirmar) return;
    
    // Deshabilitar bot√≥n durante el procesamiento
    btnConfirmarPago.disabled = true;
    btnConfirmarPago.innerHTML = '<i class="fa-solid fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Procesando...';
    
    try {
      console.log('Enviando pago:', { email, citaId, monto, metodo });
      
      const res = await fetch('http://localhost:5000/api/pagos', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, citaId, monto, metodo })
      });
      
      const data = await res.json();
      console.log('Respuesta del servidor:', data);
      
      if (!res.ok) {
        console.error('Error en la respuesta:', data);
        throw new Error(data.message || 'Error al procesar el pago');
      }
      
      // Mostrar modal de √©xito con informaci√≥n del m√©todo
      const metodoNombre = metodoSeleccionado.nextElementSibling.querySelector('span').textContent;
      
      document.getElementById('modalPago').style.display = 'flex';
      document.getElementById('modalTitulo').textContent = '¬°Pago Exitoso!';
      document.getElementById('modalMensaje').innerHTML = `
        <div style="text-align: left; margin-top: 1rem;">
          <p style="margin-bottom: 0.75rem;">Su pago ha sido procesado correctamente.</p>
          <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <strong>Monto:</strong>
              <span style="color: #059669; font-weight: 700;">S/ ${monto.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <strong>M√©todo:</strong>
              <span>${metodoNombre}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <strong>Estado:</strong>
              <span style="color: #059669; font-weight: 600;">‚úì Pagado</span>
            </div>
          </div>
        </div>
      `;
      
      // Limpiar sessionStorage
      sessionStorage.removeItem('ultimaCitaId');
      
      // Cerrar el modal y redirigir a la vista de pagos despu√©s de 2 segundos
      setTimeout(() => {
        const modalPago = document.getElementById('modalPago');
        if (modalPago) modalPago.style.display = 'none';
        
        // Redirigir a la vista de pagos para ver el nuevo pago
        // Esperar un poco m√°s para asegurar que el backend haya procesado completamente
        if (typeof loadSection === 'function') {
          console.log('Redirigiendo a la vista de pagos desde pagar-cita...');
          loadSection('pagos');
          
          // Forzar la recarga de pagos despu√©s de un delay m√°s largo para asegurar que el backend haya guardado
          // Usar m√∫ltiples intentos para asegurar que la tabla se cargue
          let intentosRecarga = 0;
          const maxIntentosRecarga = 10;
          const recargarPagos = () => {
            intentosRecarga++;
            const tbody = document.getElementById('pagos-tbody-modern');
            if (tbody && typeof window.cargarPagosEnTabla === 'function') {
              console.log(`Recargando tabla de pagos desde pagar-cita... (intento ${intentosRecarga})`);
              window.cargarPagosEnTabla();
              // Verificar despu√©s de cargar si hay datos
              setTimeout(() => {
                const filas = tbody.querySelectorAll('tr');
                console.log(`Tabla recargada: ${filas.length} filas encontradas`);
              }, 1000);
            } else if (intentosRecarga < maxIntentosRecarga) {
              setTimeout(recargarPagos, 400);
            } else {
              console.warn('No se pudo recargar la tabla de pagos despu√©s de varios intentos');
            }
          };
          // Empezar despu√©s de un delay m√°s largo para dar tiempo al backend
          setTimeout(recargarPagos, 800);
        } else {
          window.location.href = '/user';
        }
      }, 2000);
      
    } catch (error) {
      console.error('Error al procesar pago:', error);
      console.error('Stack:', error.stack);
      
      let mensajeError = 'Error al procesar el pago';
      if (error.message) {
        mensajeError = error.message;
      } else if (typeof error === 'string') {
        mensajeError = error;
      }
      
      alert('Error: ' + mensajeError + '\n\nPor favor, verifique la consola para m√°s detalles.');
      btnConfirmarPago.disabled = false;
      btnConfirmarPago.innerHTML = '<i class="fa-solid fa-check" style="margin-right: 0.5rem;"></i>Confirmar Pago';
    }
  });
  
  // Bot√≥n volver
  const btnVolverPago = document.getElementById('btnVolverPago');
  if (btnVolverPago) {
    btnVolverPago.addEventListener('click', () => {
      if (typeof loadSection === 'function') {
        loadSection('pagos');
      } else {
        window.location.href = '/user';
      }
    });
  }
  
  // Bot√≥n cancelar
  const btnCancelarPago = document.getElementById('btnCancelarPago');
  if (btnCancelarPago) {
    btnCancelarPago.addEventListener('click', () => {
      if (confirm('¬øEst√° seguro que desea cancelar el pago?')) {
        if (typeof loadSection === 'function') {
          loadSection('pagos');
        } else {
          window.location.href = '/user';
        }
      }
    });
  }
  
  // Cerrar modal
  document.getElementById('btnCerrarModal').addEventListener('click', () => {
    document.getElementById('modalPago').style.display = 'none';
    if (typeof loadSection === 'function') {
      loadSection('pagos');
    } else {
      window.location.href = '/user/citas';
    }
  });
  
  // Mostrar/ocultar campos de tarjeta seg√∫n el m√©todo seleccionado
  const camposTarjeta = document.getElementById('camposTarjeta');
  const numeroTarjetaInput = document.getElementById('numeroTarjeta');
  const fechaExpiracionInput = document.getElementById('fechaExpiracion');
  const cvvInput = document.getElementById('cvv');
  const seccionYape = document.getElementById('seccionYape');
  
  // Funci√≥n para actualizar datos en la secci√≥n Yape (definir antes de usarla)
  const actualizarDatosYape = () => {
    console.log('üîÑ Actualizando datos de Yape...');
    
    const nombrePaciente = document.getElementById('nombrePaciente')?.textContent || '-';
    const correoPaciente = document.getElementById('correoPaciente')?.textContent || '-';
    const fechaCita = document.getElementById('fechaCita')?.textContent || '-';
    const horarioCita = document.getElementById('horarioCita')?.textContent || '-';
    const montoPago = document.getElementById('montoPago')?.value || '0.00';
    
    console.log('üìã Datos obtenidos:', { nombrePaciente, correoPaciente, fechaCita, horarioCita, montoPago });
    
    // Actualizar campos en la secci√≥n Yape
    const yapeNombrePaciente = document.getElementById('yapeNombrePaciente');
    const yapeCorreoPaciente = document.getElementById('yapeCorreoPaciente');
    const yapeFechaCita = document.getElementById('yapeFechaCita');
    const yapeHorarioCita = document.getElementById('yapeHorarioCita');
    const yapeImporte = document.getElementById('yapeImporte');
    
    if (yapeNombrePaciente) {
      yapeNombrePaciente.textContent = nombrePaciente;
      console.log('‚úÖ Nombre actualizado:', nombrePaciente);
    } else {
      console.error('‚ùå Elemento yapeNombrePaciente no encontrado');
    }
    
    if (yapeCorreoPaciente) {
      yapeCorreoPaciente.textContent = correoPaciente;
      console.log('‚úÖ Correo actualizado:', correoPaciente);
    } else {
      console.error('‚ùå Elemento yapeCorreoPaciente no encontrado');
    }
    
    if (yapeFechaCita) {
      yapeFechaCita.textContent = fechaCita;
      console.log('‚úÖ Fecha actualizada:', fechaCita);
    } else {
      console.error('‚ùå Elemento yapeFechaCita no encontrado');
    }
    
    if (yapeHorarioCita) {
      yapeHorarioCita.textContent = horarioCita;
      console.log('‚úÖ Horario actualizado:', horarioCita);
    } else {
      console.error('‚ùå Elemento yapeHorarioCita no encontrado');
    }
    
    if (yapeImporte) {
      yapeImporte.textContent = `S/ ${parseFloat(montoPago).toFixed(2)}`;
      console.log('‚úÖ Importe actualizado:', montoPago);
    } else {
      console.error('‚ùå Elemento yapeImporte no encontrado');
    }
    
    console.log('‚úÖ Actualizaci√≥n de datos Yape completada');
  };
  
  // Hacer la funci√≥n disponible globalmente para uso en otras partes del c√≥digo
  window.actualizarDatosYape = actualizarDatosYape;
  
  const toggleCamposTarjeta = (mostrar) => {
    if (camposTarjeta) {
      camposTarjeta.style.display = mostrar ? 'block' : 'none';
      // Limpiar campos cuando se ocultan
      if (!mostrar) {
        if (numeroTarjetaInput) numeroTarjetaInput.value = '';
        if (fechaExpiracionInput) fechaExpiracionInput.value = '';
        if (cvvInput) cvvInput.value = '';
        // Remover clases de error
        [numeroTarjetaInput, fechaExpiracionInput, cvvInput].forEach(input => {
          if (input) input.style.borderColor = '#e5e7eb';
        });
      }
    }
  };
  
  // Mostrar/ocultar secci√≥n Yape seg√∫n el m√©todo seleccionado
  const toggleSeccionYape = (mostrar) => {
    if (seccionYape) {
      console.log('Toggle secci√≥n Yape:', mostrar);
      seccionYape.style.display = mostrar ? 'block' : 'none';
      if (mostrar) {
        // Esperar un momento para asegurar que los datos est√©n cargados
        setTimeout(() => {
          // Actualizar datos en la secci√≥n Yape
          actualizarDatosYape();
        }, 100);
      }
    } else {
      console.warn('Secci√≥n Yape no encontrada en el DOM');
    }
  };
  
  // Verificar m√©todo inicial y configurar estado correctamente
  const metodoInicial = document.querySelector('input[name="metodo"]:checked');
  console.log('M√©todo inicial:', metodoInicial?.value);
  
  if (metodoInicial) {
    if (metodoInicial.value === 'tarjeta') {
      console.log('Configurando estado inicial: Tarjeta seleccionada');
      toggleCamposTarjeta(true);
      toggleSeccionYape(false);
    } else if (metodoInicial.value === 'yape') {
      console.log('Configurando estado inicial: Yape seleccionada');
      toggleCamposTarjeta(false);
      toggleSeccionYape(true);
    } else {
      console.log('Configurando estado inicial: Otro m√©todo seleccionado');
      toggleCamposTarjeta(false);
      toggleSeccionYape(false);
    }
  } else {
    console.log('No hay m√©todo inicial seleccionado, ocultando ambos');
    toggleCamposTarjeta(false);
    toggleSeccionYape(false);
  }
  
  // Formatear n√∫mero de tarjeta (agregar espacios cada 4 d√≠gitos)
  if (numeroTarjetaInput) {
    numeroTarjetaInput.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
      const formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
      e.target.value = formattedValue;
    });
    
    numeroTarjetaInput.addEventListener('blur', (e) => {
      const value = e.target.value.replace(/\s+/g, '');
      if (value.length > 0 && value.length < 16) {
        e.target.style.borderColor = '#ef4444';
      } else {
        e.target.style.borderColor = '#e5e7eb';
      }
    });
  }
  
  // Formatear fecha de expiraci√≥n (MM/AA)
  if (fechaExpiracionInput) {
    fechaExpiracionInput.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
      }
      e.target.value = value;
    });
    
    fechaExpiracionInput.addEventListener('blur', (e) => {
      const value = e.target.value.replace(/\D/g, '');
      if (value.length === 4) {
        const mes = parseInt(value.substring(0, 2));
        const ano = parseInt(value.substring(2, 4));
        if (mes < 1 || mes > 12) {
          e.target.style.borderColor = '#ef4444';
        } else {
          e.target.style.borderColor = '#e5e7eb';
        }
      } else if (value.length > 0) {
        e.target.style.borderColor = '#ef4444';
      } else {
        e.target.style.borderColor = '#e5e7eb';
      }
    });
  }
  
  // Validar CVV (solo n√∫meros)
  if (cvvInput) {
    cvvInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
    });
    
    cvvInput.addEventListener('blur', (e) => {
      const value = e.target.value;
      if (value.length > 0 && (value.length < 3 || value.length > 4)) {
        e.target.style.borderColor = '#ef4444';
      } else {
        e.target.style.borderColor = '#e5e7eb';
      }
    });
  }
  
  // Funci√≥n para validar campos de tarjeta
  const validarCamposTarjeta = () => {
    if (!camposTarjeta || camposTarjeta.style.display === 'none') {
      return true; // No hay campos de tarjeta visibles, no validar
    }
    
    const numeroTarjeta = numeroTarjetaInput?.value.replace(/\s+/g, '') || '';
    const fechaExpiracion = fechaExpiracionInput?.value.replace(/\D/g, '') || '';
    const cvv = cvvInput?.value || '';
    
    let isValid = true;
    let mensajeError = '';
    
    // Validar n√∫mero de tarjeta (16 d√≠gitos)
    if (numeroTarjeta.length !== 16) {
      isValid = false;
      mensajeError += 'El n√∫mero de tarjeta debe tener 16 d√≠gitos.\n';
      if (numeroTarjetaInput) numeroTarjetaInput.style.borderColor = '#ef4444';
    } else {
      if (numeroTarjetaInput) numeroTarjetaInput.style.borderColor = '#e5e7eb';
    }
    
    // Validar fecha de expiraci√≥n (MM/AA, 4 d√≠gitos)
    if (fechaExpiracion.length !== 4) {
      isValid = false;
      mensajeError += 'La fecha de expiraci√≥n debe tener formato MM/AA.\n';
      if (fechaExpiracionInput) fechaExpiracionInput.style.borderColor = '#ef4444';
    } else {
      const mes = parseInt(fechaExpiracion.substring(0, 2));
      if (mes < 1 || mes > 12) {
        isValid = false;
        mensajeError += 'El mes de expiraci√≥n debe estar entre 01 y 12.\n';
        if (fechaExpiracionInput) fechaExpiracionInput.style.borderColor = '#ef4444';
      } else {
        if (fechaExpiracionInput) fechaExpiracionInput.style.borderColor = '#e5e7eb';
      }
    }
    
    // Validar CVV (3 o 4 d√≠gitos)
    if (cvv.length < 3 || cvv.length > 4) {
      isValid = false;
      mensajeError += 'El CVV debe tener 3 o 4 d√≠gitos.\n';
      if (cvvInput) cvvInput.style.borderColor = '#ef4444';
    } else {
      if (cvvInput) cvvInput.style.borderColor = '#e5e7eb';
    }
    
    if (!isValid) {
      alert('Por favor corrija los siguientes errores:\n\n' + mensajeError);
    }
    
    return isValid;
  };
  
  // Manejar cambio de m√©todo de pago seleccionado
  const metodoInputs = document.querySelectorAll('input[name="metodo"]');
  metodoInputs.forEach(input => {
    input.addEventListener('change', function() {
      // Remover clase selected de todas las opciones
      document.querySelectorAll('.metodo-pago-option').forEach(option => {
        option.classList.remove('selected');
      });
      // Agregar clase selected a la opci√≥n seleccionada
      const selectedOption = document.getElementById(`option-${this.value}`);
      if (selectedOption) {
        selectedOption.classList.add('selected');
      }
      
      // Mostrar/ocultar campos de tarjeta y secci√≥n Yape seg√∫n el m√©todo seleccionado
      console.log('M√©todo seleccionado:', this.value);
      if (this.value === 'tarjeta') {
        console.log('Mostrando campos de tarjeta, ocultando Yape');
        toggleCamposTarjeta(true);
        toggleSeccionYape(false);
      } else if (this.value === 'yape') {
        console.log('Mostrando secci√≥n Yape, ocultando campos de tarjeta');
        toggleCamposTarjeta(false);
        toggleSeccionYape(true);
      } else {
        console.log('Ocultando ambos');
        toggleCamposTarjeta(false);
        toggleSeccionYape(false);
      }
    });
  });

      // Cargar informaci√≥n
      cargarInfoPaciente();
      cargarInfoCita();
    });
  }
})();
</script>

